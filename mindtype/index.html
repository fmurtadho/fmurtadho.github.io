<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindType Typeracer</title>
    <!-- Pixel Font -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Core Gruvbox Palette */
            --bg-hard: #1d2021;
            --bg-soft: #282828;
            --fg: #ebdbb2;
            --fg-dim: #928374; 
            --red: #cc241d;
            --green: #98971a;
            --yellow: #d79921;
            --blue: #458588;
            --purple: #b16286;
            --aqua: #689d6a;
            --orange: #d65d0e;
            --gray: #a89984;
            
            /* Dynamic Accent */
            --accent: #d79921; 
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none; 
        }

        body {
            background-color: var(--bg-hard);
            color: var(--fg);
            font-family: 'VT323', monospace; /* Pixel Font */
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-size: 20px; /* Base size up for legibility */
        }

        /* --- CRT Scanline Effect --- */
        .scanlines {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.1) 50%,
                rgba(0,0,0,0.1)
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 999;
        }

        /* --- Layout & Utility --- */
        .container {
            width: 100%;
            max-width: 1000px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            padding: 1rem;
        }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Header --- */
        .logo {
            font-size: 3.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 0px var(--bg-soft);
        }
        
        .logo span { color: var(--accent); }

        .subtitle {
            color: var(--fg-dim);
            margin-bottom: 2rem;
            font-size: 1.2rem;
            text-transform: uppercase;
        }

        /* --- Selection Grid --- */
        .selection-screen {
            text-align: center;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            scrollbar-width: none; /* Hide scrollbar for cleaner look */
        }

        .masters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            width: 100%;
            padding-bottom: 4rem;
        }

        .master-card {
            background: var(--bg-soft);
            border: 4px solid var(--fg-dim); /* Chunky border */
            padding: 1.5rem;
            cursor: pointer;
            transition: transform 0.1s;
            text-align: left;
            position: relative;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .master-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent); /* Highlight border */
        }

        .master-card:active {
            transform: translateY(0px);
        }

        .master-info { flex: 1; }

        .master-role {
            font-size: 1rem;
            color: var(--fg-dim);
            text-transform: uppercase;
            margin-bottom: 0.2rem;
        }

        .master-name {
            font-size: 1.8rem;
            color: var(--fg);
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .master-quote-preview {
            color: var(--fg-dim);
            font-size: 1rem;
            opacity: 0.8;
            font-style: italic;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Dynamic Hover Colors handled by JS inline styles on cards */
        .card-accent-hover:hover { border-color: var(--hover-color); }
        .card-accent-hover:hover .master-role { color: var(--hover-color); }

        /* --- Typing Screen --- */
        .typing-screen {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            gap: 1rem;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            color: var(--accent);
            font-size: 1.5rem;
            text-transform: uppercase;
            border-bottom: 4px solid var(--bg-soft);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        /* --- Battle Canvas --- */
        .battle-arena-canvas {
            width: 100%;
            height: 160px; /* Taller for nice big pixels */
            background: #151718; /* Darker than hard bg for contrast */
            border: 4px solid var(--fg-dim);
            image-rendering: pixelated; /* Crucial for crispy pixels */
            display: block;
        }

        /* --- Text Area --- */
        .typing-area-wrapper {
            position: relative;
            min-height: 120px;
            font-size: 2rem; /* Big pixel text */
            line-height: 1.4;
            cursor: text;
            margin-top: 1rem;
        }

        #words {
            color: var(--fg-dim);
            position: relative;
            z-index: 2;
        }

        .word {
            display: inline-block;
            margin-right: 0.75rem; /* Space between words */
        }

        .letter {
            border-bottom: 2px solid transparent; /* Guide line */
        }
        .letter.correct { color: var(--fg); }
        .letter.incorrect { 
            color: var(--red); 
            border-bottom: 2px solid var(--red);
            background: rgba(204, 36, 29, 0.1);
        }

        /* Block Caret */
        #caret {
            width: 14px;
            height: 2.2rem;
            background-color: var(--accent);
            position: absolute;
            top: 0; left: 0;
            z-index: 1;
            transition: left 0.05s ease-out, top 0.05s ease-out; 
            opacity: 0.7;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }
        .typing #caret { animation: none; opacity: 0.9; }

        /* --- Footer --- */
        .footer-nav {
            margin-top: 2rem;
            display: flex;
            gap: 2rem;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--fg-dim);
        }

        .btn-text {
            background: none;
            border: none;
            color: var(--fg-dim);
            font-family: inherit;
            font-size: inherit;
            cursor: pointer;
            text-transform: uppercase;
        }
        .btn-text:hover { color: var(--accent); text-decoration: underline; }

        .key-hint {
            border: 1px solid var(--fg-dim);
            padding: 0 6px;
            border-radius: 2px;
            color: var(--fg);
            font-size: 0.9em;
        }

        /* --- Overlays (Quote Select & Results) --- */
        .overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(29, 32, 33, 0.95);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .overlay-box {
            width: 100%;
            max-width: 800px;
            border: 4px solid var(--fg);
            background: var(--bg-hard);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-height: 80vh;
        }

        /* Scrollable list */
        .scroll-list {
            width: 100%;
            overflow-y: auto;
            padding-right: 1rem;
            scrollbar-color: var(--accent) var(--bg-soft);
            scrollbar-width: thin;
        }

        .list-item {
            padding: 1rem;
            border-bottom: 2px dashed var(--bg-soft);
            cursor: pointer;
            color: var(--fg-dim);
            text-align: left;
        }
        .list-item:hover { color: var(--accent); background: var(--bg-soft); }

        .btn-pixel {
            margin-top: 1rem;
            background: var(--bg-soft);
            color: var(--accent);
            border: 4px solid var(--accent);
            padding: 1rem 3rem;
            font-family: inherit;
            font-size: 1.5rem;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.1s;
        }
        .btn-pixel:hover {
            background: var(--accent);
            color: var(--bg-hard);
            transform: translateY(-2px);
        }
        .btn-pixel:active { transform: translateY(2px); }

        /* Updated Results Stats Styles */
        .stat-big { 
            font-size: 7rem; 
            line-height: 0.9; 
            color: var(--accent); 
            margin-bottom: 0; 
        }
        .stat-label { 
            font-size: 1.5rem; 
            color: var(--fg-dim); 
            text-transform: uppercase; 
            margin-bottom: 1rem; 
        }
        
        .secondary-stats {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 1.4rem;
            color: var(--fg);
            width: 100%;
        }
        
        .sec-stat-group { 
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sec-stat-lbl { 
            color: var(--fg-dim); 
            text-transform: uppercase;
            font-size: 1.2rem;
        }
        
        .sec-stat-val {
            color: var(--accent);
            font-weight: bold;
        }
        
        /* Updated Insight Box Styles */
        .insight-box { /* Kept for structural reference if needed, but unused in new layout */
            margin: 1rem 0;
            padding: 1.5rem;
            text-align: center;
            max-width: 100%;
        }
        
        .insight-text { 
            font-size: 1.8rem; /* Larger font */
            color: var(--accent); /* Pop with accent color */
            font-style: italic; 
            line-height: 1.4;
            text-shadow: 1px 1px 0px rgba(0,0,0,0.5);
        }
        
        .insight-source {
            display: block;
            margin-top: 0.8rem;
            font-size: 1.2rem;
            color: var(--fg-dim);
            font-style: normal;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-group {
            display: flex;
            gap: 1.5rem;
            margin-top: 0.5rem;
        }

        /* WPM Chart */
        .wpm-chart-box {
            width: 100%;
            height: 180px; 
            margin: 0;
            border: 2px solid var(--fg-dim);
            background: #151718;
            position: relative;
            cursor: crosshair;
        }
        .wpm-chart-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* Score Box */
        .score-box {
            width: 100%;
            background: var(--bg-soft);
            border: 2px solid var(--fg-dim);
            padding: 1rem;
            font-size: 1.1rem;
        }
        .score-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.3rem;
            color: var(--fg-dim);
        }
        .score-row.final {
            border-top: 2px solid var(--fg);
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            color: var(--accent);
            font-size: 1.4rem;
            font-weight: bold;
        }
        .score-penalty { color: var(--red); }
        
        /* Results Grid */
        .results-container {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr; /* Chart bigger, Stats smaller */
            grid-template-rows: auto auto auto auto;
            gap: 1.5rem;
            width: 100%;
            max-width: 900px;
            background: var(--bg-hard);
            border: 4px solid var(--fg-dim);
            padding: 2rem;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            align-items: center; /* Vertically center items */
        }
        .results-header { grid-column: 1 / -1; text-align: center; border-bottom: 2px dashed var(--bg-soft); padding-bottom: 1rem; margin-bottom: 0.5rem; }
        
        .results-chart-area { 
            grid-column: 1 / 2; 
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            height: 100%;
        }
        
        .results-stats-area { 
            grid-column: 2 / 3; 
            display: flex; 
            flex-direction: column; 
            gap: 0.5rem;
            justify-content: center;
            height: 100%;
        }
        
        /* Updated Insight Area in Grid */
        .results-insight-area { 
            grid-column: 1 / -1; 
            margin-top: 1rem;
            text-align: center; /* Center alignment */
            border-top: 2px dashed var(--fg-dim);
            border-bottom: 2px dashed var(--fg-dim);
            padding: 2rem 1rem;
            background: rgba(0,0,0,0.1); /* Subtle background to make it pop */
        }
        .results-actions { grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
        
        @media (max-width: 700px) {
            .results-container { grid-template-columns: 1fr; }
            .results-chart-area, .results-stats-area { grid-column: 1 / -1; }
        }

        #hidden-input { opacity: 0; position: absolute; z-index: -1; }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <input type="text" id="hidden-input" autocomplete="off" autocapitalize="off" spellcheck="false">

    <!-- Screen 1: Master Selection -->
    <div id="selection-screen" class="container selection-screen fade-in">
        <div class="logo">Mind<span>Type</span></div>
        <div class="subtitle">Select Character</div>

        <div class="masters-grid" id="masters-grid-container"></div>
    </div>

    <!-- Screen 2: Game Interface -->
    <div id="typing-screen" class="container typing-screen hidden">
        <div class="stats-bar" id="stats-bar">
            <div><span id="live-wpm">0</span> WPM</div>
            <div id="master-indicator">THE GENERAL</div>
            <div><span id="live-acc">100</span>% ACC</div>
        </div>

        <canvas id="battle-canvas" class="battle-arena-canvas"></canvas>

        <div class="typing-area-wrapper" id="game-wrapper">
            <div id="caret"></div>
            <div id="words"></div>
        </div>

        <div class="footer-nav">
            <div><span class="key-hint">TAB</span> RESTART</div>
            <div><span class="key-hint">ESC</span> MENU</div>
            <button class="btn-text" onclick="showQuoteSelection()">[ SELECT MISSION ]</button>
        </div>
    </div>

    <!-- Screen 3: Quote Selection -->
    <div id="quote-selection" class="overlay hidden">
        <div class="overlay-box">
            <h2 class="subtitle" style="margin-top:0;">Available Wisdom</h2>
            <div id="quote-list" class="scroll-list"></div>
            <button class="btn-pixel" onclick="closeQuoteSelection()">BACK</button>
        </div>
    </div>

    <!-- Screen 4: Results -->
    <div id="results-screen" class="overlay hidden">
        <div class="results-container">
            <!-- Header -->
            <div class="results-header">
                <div class="stat-big" id="res-wpm">0</div>
                <div class="stat-label" style="margin:0;">WPM</div>
            </div>

            <!-- Left: Chart -->
            <div class="results-chart-area">
                <div class="wpm-chart-box">
                    <canvas id="wpm-chart" class="wpm-chart-canvas"></canvas>
                </div>
            </div>

            <!-- Right: Stats & Score -->
            <div class="results-stats-area">
                <div class="secondary-stats">
                    <div class="sec-stat-group">
                        <span class="sec-stat-lbl">ACC:</span>
                        <span class="sec-stat-val" id="res-acc">0%</span>
                    </div>
                    <div class="sec-stat-group">
                        <span class="sec-stat-lbl">TIME:</span>
                        <span class="sec-stat-val" id="res-time">0s</span>
                    </div>
                </div>
                <div class="score-box" id="score-breakdown">
                    <!-- Populated via JS -->
                </div>
            </div>

            <!-- Bottom: Insight -->
            <div class="results-insight-area">
                <div class="insight-text" id="res-insight"></div>
            </div>

            <!-- Footer: Actions -->
            <div class="results-actions">
                <div class="btn-group">
                    <button class="btn-pixel" onclick="retryMission()">RETRY <span class="key-hint" style="font-size:0.8em">TAB</span></button>
                    <button class="btn-pixel" onclick="nextMission()">NEXT BATTLE <span class="key-hint" style="font-size:0.8em">ENTER</span></button>
                </div>
                <button class="btn-text" style="margin-top:1rem;" onclick="toMenu()">Character Select <span class="key-hint" style="font-size:0.8em">ESC</span></button>
            </div>
        </div>
    </div>

    <script>
        // --- Data: Masters & Quotes & Sources ---
        const masters = {
            tzu: {
                key: 'tzu',
                name: "Sun Tzu",
                role: "The General",
                color: "#d79921",
                quotes: [
                    { text: "The supreme art of war is to subdue the enemy without fighting.", insight: "Strategy beats force.", source: "The Art of War" },
                    { text: "In the midst of chaos, there is also opportunity.", insight: "Look for openings when others panic.", source: "The Art of War" },
                    { text: "Appear weak when you are strong, and strong when you are weak.", insight: "Deception is key to warfare.", source: "The Art of War" },
                    { text: "Victorious warriors win first and then go to war, while defeated warriors go to war first and then seek to win.", insight: "Preparation determines the outcome.", source: "The Art of War" },
                    { text: "Even the finest sword plunged into salt water will eventually rust.", insight: "Maintain your skills and tools.", source: "The Art of War" },
                    { text: "Treat your men as you would your own beloved sons. And they will follow you into the deepest valley.", insight: "Loyalty is earned through care.", source: "The Art of War" },
                    { text: "Move swift as the Wind and closely-formed as the Wood. Attack like the Fire and be still as the Mountain.", insight: "Adapt your nature to the situation.", source: "The Art of War" },
                    { text: "Opportunities multiply as they are seized.", insight: "Action creates momentum.", source: "The Art of War" },
                    { text: "The greatest victory is that which requires no battle.", insight: "Peace is the ultimate strategic goal.", source: "The Art of War" },
                    { text: "If you wait by the river long enough, the bodies of your enemies will float by.", insight: "Patience allows time to defeat your foes.", source: "The Art of War" },
                    { text: "He who wishes to fight must first count the cost.", insight: "Understand the price of conflict.", source: "The Art of War" },
                    { text: "To know your Enemy, you must become your Enemy.", insight: "Empathy leads to prediction.", source: "The Art of War" },
                    { text: "Strategy without tactics is the slowest route to victory. Tactics without strategy is the noise before defeat.", insight: "Vision needs action; action needs vision.", source: "The Art of War" },
                    { text: "Build your opponent a golden bridge to retreat across.", insight: "Desperate enemies fight harder; leave them an exit.", source: "The Art of War" },
                    { text: "Sweat more during peace: bleed less during war.", insight: "Hard training prevents hard losses.", source: "The Art of War" }
                ]
            },
            laotzu: {
                key: 'laotzu',
                name: "Lao Tzu",
                role: "The Sage",
                color: "#98971a",
                quotes: [
                    { text: "Nature does not hurry, yet everything is accomplished.", insight: "Patience aligns with the Tao.", source: "Tao Te Ching" },
                    { text: "The journey of a thousand miles begins with a single step.", insight: "Focus on the start, not the distance.", source: "Tao Te Ching" },
                    { text: "Knowing others is intelligence; knowing yourself is true wisdom.", insight: "Self-awareness is the ultimate power.", source: "Tao Te Ching" },
                    { text: "He who knows that enough is enough will always have enough.", insight: "Contentment is true wealth.", source: "Tao Te Ching" },
                    { text: "Act without expectation.", insight: "Detach from the outcome to find peace.", source: "Tao Te Ching" },
                    { text: "Silence is a source of great strength.", insight: "In stillness, power accumulates.", source: "Tao Te Ching" },
                    { text: "If you are depressed you are living in the past. If you are anxious you are living in the future.", insight: "Presence is the cure for suffering.", source: "Tao Te Ching" },
                    { text: "Be content with what you have; rejoice in the way things are.", insight: "Acceptance opens the world to you.", source: "Tao Te Ching" },
                    { text: "The truth is not always beautiful, nor beautiful words the truth.", insight: "Reality is often plain or harsh.", source: "Tao Te Ching" },
                    { text: "A leader is best when people barely know he exists.", insight: "True leadership empowers others, not the self.", source: "Tao Te Ching" },
                    { text: "When I let go of what I am, I become what I might be.", insight: "Release your identity to find your potential.", source: "Tao Te Ching" },
                    { text: "Great acts are made up of small deeds.", insight: "Consistency builds greatness.", source: "Tao Te Ching" },
                    { text: "Anticipate the difficult by managing the easy.", insight: "Solve problems before they become crises.", source: "Tao Te Ching" },
                    { text: "He who conquers others is strong; he who conquers himself is mighty.", insight: "Internal victory is the hardest battle.", source: "Tao Te Ching" },
                    { text: "Kindness in words creates confidence. Kindness in giving creates love.", insight: "Benevolence is a creative force.", source: "Tao Te Ching" }
                ]
            },
            musashi: {
                key: 'musashi',
                name: "Musashi",
                role: "The Ronin",
                color: "#458588",
                quotes: [
                    { text: "Think lightly of yourself and deeply of the world.", insight: "Remove ego to see clearly.", source: "The Book of Five Rings" },
                    { text: "Do not regret what you have done.", insight: "Accept the past to move forward.", source: "The Book of Five Rings" },
                    { text: "There is more than one path to the top of the mountain.", insight: "Be adaptable in your methods.", source: "The Book of Five Rings" },
                    { text: "Get beyond love and grief: exist for the good of Man.", insight: "Detachment brings clarity.", source: "The Book of Five Rings" },
                    { text: "You can only fight the way you practice.", insight: " habits define performance.", source: "The Book of Five Rings" },
                    { text: "Today is victory over yourself of yesterday; tomorrow is your victory over lesser men.", insight: "Constant self-improvement is the goal.", source: "The Book of Five Rings" },
                    { text: "Truth is not what you want it to be; it is what it is.", insight: "Accept reality without delusion.", source: "The Book of Five Rings" },
                    { text: "Generally speaking, the Way of the warrior is resolute acceptance of death.", insight: "Fearlessness comes from acceptance.", source: "The Book of Five Rings" },
                    { text: "In battles, if you make your opponent flinch, you have already won.", insight: "Psychological dominance precedes physical victory.", source: "The Book of Five Rings" },
                    { text: "If you wish to control others you must first control yourself.", insight: "Mastery begins within.", source: "The Book of Five Rings" },
                    { text: "It is difficult to understand the universe if you only study one planet.", insight: "Broaden your perspective.", source: "The Book of Five Rings" },
                    { text: "Do not hold on to possessions you no longer need.", insight: "Travel light in life.", source: "The Book of Five Rings" },
                    { text: "Perceive that which cannot be seen with the eye.", insight: "Intuition is a warrior's tool.", source: "The Book of Five Rings" },
                    { text: "Do nothing which is of no use.", insight: "Efficiency is a lifestyle.", source: "The Book of Five Rings" },
                    { text: "Step by step walk the thousand-mile road.", insight: "Persistence conquers distance.", source: "The Book of Five Rings" }
                ]
            },
            nietzsche: {
                key: 'nietzsche',
                name: "Nietzsche",
                role: "The Prophet",
                color: "#b16286",
                quotes: [
                    { text: "He who has a why to live for can bear almost any how.", insight: "Purpose fuels endurance.", source: "Twilight of the Idols" },
                    { text: "That which does not kill us makes us stronger.", insight: "Adversity builds character.", source: "Twilight of the Idols" },
                    { text: "And if you gaze long enough into an abyss, the abyss will gaze back into you.", insight: "Be careful what you fight.", source: "Beyond Good and Evil" },
                    { text: "The individual has always had to struggle to keep from being overwhelmed by the tribe.", insight: "Authenticity requires courage.", source: "Selected Works" },
                    { text: "He who fights with monsters should look to it that he himself does not become a monster.", insight: "Guard your soul in conflict.", source: "Beyond Good and Evil" },
                    { text: "The snake which cannot cast its skin has to die.", insight: "Change is necessary for survival.", source: "Dawn" },
                    { text: "Sometimes people don't want to hear the truth because they don't want their illusions destroyed.", insight: "Comfort is often preferred over reality.", source: "Selected Works" },
                    { text: "It is not a lack of love, but a lack of friendship that makes unhappy marriages.", insight: "Companionship sustains relationships.", source: "Thus Spoke Zarathustra" },
                    { text: "You shall become the person you are.", insight: "Self-actualization is a duty.", source: "The Gay Science" },
                    { text: "There is always some madness in love. But there is also always some reason in madness.", insight: "Emotion has its own logic.", source: "Thus Spoke Zarathustra" },
                    { text: "No price is too high to pay for the privilege of owning yourself.", insight: "Freedom is the highest value.", source: "Selected Works" },
                    { text: "Without music, life would be a mistake.", insight: "Art is essential for existence.", source: "Twilight of the Idols" },
                    { text: "One must still have chaos in oneself to be able to give birth to a dancing star.", insight: "Creativity requires inner turmoil.", source: "Thus Spoke Zarathustra" },
                    { text: "To live is to suffer, to survive is to find some meaning in the suffering.", insight: "Meaning transforms pain.", source: "Selected Works" },
                    { text: "All things are subject to interpretation whichever interpretation prevails is a function of power.", insight: "Truth is often defined by the victor.", source: "The Will to Power" }
                ]
            },
            machiavelli: {
                key: 'machiavelli',
                name: "Machiavelli",
                role: "The Prince",
                color: "#cc241d",
                quotes: [
                    { text: "It is better to be feared than loved, if you cannot be both.", insight: "Control is more reliable than affection.", source: "The Prince" },
                    { text: "Never attempt to win by force what can be won by deception.", insight: "Efficiency over brute strength.", source: "The Prince" },
                    { text: "The first method for estimating the intelligence of a ruler is to look at the men he has around him.", insight: "Your company defines your capability.", source: "The Prince" },
                    { text: "Where the willingness is great, the difficulties cannot be great.", insight: "Willpower overcomes obstacles.", source: "The Prince" },
                    { text: "Entrepreneurs are simply those who understand that there is little difference between obstacle and opportunity.", insight: "Perspective shifts reality.", source: "The Prince" },
                    { text: "Everyone sees what you appear to be, few experience what you really are.", insight: "Image is power.", source: "The Prince" },
                    { text: "The lion cannot protect himself from traps, and the fox cannot defend himself from wolves.", insight: "Combine strength with cunning.", source: "The Prince" },
                    { text: "There is no other way to guard yourself against flattery than by making men understand that telling you the truth will not offend you.", insight: "Encourage honesty to avoid delusion.", source: "The Prince" },
                    { text: "A prudent man should always follow in the footsteps of great men.", insight: "Learn from those who succeeded before.", source: "The Prince" },
                    { text: "He who wishes to be obeyed must know how to command.", insight: "Authority requires competence.", source: "The Prince" },
                    { text: "Men are so simple and so much inclined to obey immediate needs that a deceiver will never lack victims.", insight: "People are easily manipulated by desire.", source: "The Prince" },
                    { text: "Politics have no relation to morals.", insight: "Pragmatism ignores ethics.", source: "The Prince" },
                    { text: "The promise given was a necessity of the past: the word broken is a necessity of the present.", insight: "Adaptability supersedes consistency.", source: "The Prince" },
                    { text: "It is double pleasure to deceive the deceiver.", insight: "Outsmarting a fox is satisfying.", source: "The Prince" },
                    { text: "Hatred is gained as much by good works as by evil.", insight: "Action always invites reaction.", source: "The Prince" }
                ]
            },
            aurelius: {
                key: 'aurelius',
                name: "Marcus Aurelius",
                role: "The Stoic",
                color: "#689d6a",
                quotes: [
                    { text: "You have power over your mind - not outside events. Realize this, and you will find strength.", insight: "Control originates from within.", source: "Meditations" },
                    { text: "The happiness of your life depends upon the quality of your thoughts.", insight: "Mindset shapes reality.", source: "Meditations" },
                    { text: "Waste no more time arguing about what a good man should be. Be one.", insight: "Action over definition.", source: "Meditations" },
                    { text: "The best revenge is to be unlike him who performed the injury.", insight: "Rise above conflict.", source: "Meditations" },
                    { text: "It is not death that a man should fear, but he should fear never beginning to live.", insight: "Exist with purpose.", source: "Meditations" },
                    { text: "Accept the things to which fate binds you, and love the people with whom fate brings you together, but do so with all your heart.", insight: "Embrace your destiny fully.", source: "Meditations" },
                    { text: "Very little is needed to make a happy life; it is all within yourself, in your way of thinking.", insight: "Happiness is an internal creation.", source: "Meditations" },
                    { text: "Reject your sense of injury and the injury itself disappears.", insight: "Perception defines pain.", source: "Meditations" },
                    { text: "When you arise in the morning think of what a privilege it is to be alive, to think, to enjoy, to love.", insight: "Gratitude fuels life.", source: "Meditations" },
                    { text: "The object of life is not to be on the side of the majority, but to escape finding oneself in the ranks of the insane.", insight: "Think independently.", source: "Meditations" },
                    { text: "Loss is nothing else but change, and change is Nature's delight.", insight: "Embrace the flow of change.", source: "Meditations" },
                    { text: "Do every act of your life as if it were the last.", insight: "Live with urgency and focus.", source: "Meditations" },
                    { text: "Confine yourself to the present.", insight: "The now is all you possess.", source: "Meditations" },
                    { text: "Whatever the universal nature assigns to any man at any time is for the good of that man at that time.", insight: "Trust in the cosmic order.", source: "Meditations" },
                    { text: "He who lives in harmony with himself lives in harmony with the universe.", insight: "Inner peace aligns with outer order.", source: "Meditations" }
                ]
            },
            confucius: {
                key: 'confucius',
                name: "Confucius",
                role: "The Mentor",
                color: "#d65d0e",
                quotes: [
                    { text: "It does not matter how slowly you go as long as you do not stop.", insight: "Persistence ensures success.", source: "The Analects" },
                    { text: "Our greatest glory is not in never falling, but in rising every time we fall.", insight: "Resilience defines character.", source: "The Analects" },
                    { text: "Wheresoever you go, go with all your heart.", insight: "Commit fully to your path.", source: "The Analects" },
                    { text: "Real knowledge is to know the extent of one's ignorance.", insight: "Humility opens the mind.", source: "The Analects" },
                    { text: "Everything has beauty, but not everyone sees it.", insight: "Perspective changes value.", source: "The Analects" },
                    { text: "What the superior man seeks is in himself; what the small man seeks is in others.", insight: "Self-reliance vs dependency.", source: "The Analects" },
                    { text: "Respect yourself and others will respect you.", insight: "Dignity starts within.", source: "The Analects" },
                    { text: "Attack the evil that is within yourself, rather than attacking the evil that is in others.", insight: "Focus on self-correction.", source: "The Analects" },
                    { text: "The man who moves a mountain begins by carrying away small stones.", insight: "Big goals require small steps.", source: "The Analects" },
                    { text: "When anger rises, think of the consequences.", insight: "Patience prevents regret.", source: "The Analects" },
                    { text: "To be wronged is nothing, unless you continue to remember it.", insight: "Forgiveness frees the mind.", source: "The Analects" },
                    { text: "By three methods we may learn wisdom: First, by reflection, which is noblest; Second, by imitation, which is easiest; and third by experience, which is the bitterest.", insight: "Choose your path to wisdom.", source: "The Analects" },
                    { text: "He who learns but does not think, is lost! He who thinks but does not learn is in great danger.", insight: "Balance study with thought.", source: "The Analects" },
                    { text: "The will to win, the desire to succeed, the urge to reach your full potential... these are the keys that will unlock the door to personal excellence.", insight: "Drive creates excellence.", source: "The Analects" },
                    { text: "Study the past if you would define the future.", insight: "History informs destiny.", source: "The Analects" },
                ]
            },
            rumi: {
                key: 'rumi',
                name: "Rumi",
                role: "The Mystic",
                color: "#a89984",
                quotes: [
                    { text: "The wound is the place where the Light enters you.", insight: "Pain brings enlightenment.", source: "Selected Poems" },
                    { text: "Stop acting so small. You are the universe in ecstatic motion.", insight: "Recognize your cosmic nature.", source: "Selected Poems" },
                    { text: "Yesterday I was clever, so I wanted to change the world. Today I am wise, so I am changing myself.", insight: "True change is internal.", source: "Selected Poems" },
                    { text: "Don't be satisfied with stories, how things have gone with others. Unfold your own myth.", insight: "Live your own truth.", source: "Selected Poems" },
                    { text: "Raise your words, not voice. It is rain that grows flowers, not thunder.", insight: "Gentleness persuades better than force.", source: "Selected Poems" },
                    { text: "Lovers don't finally meet somewhere. They're in each other all along.", insight: "Connection is inherent.", source: "Selected Poems" },
                    { text: "Knock, And He'll open the door. Vanish, And He'll make you shine like the sun.", insight: "Ego dissolution leads to glory.", source: "Selected Poems" },
                    { text: "When you do things from your soul, you feel a river moving in you, a joy.", insight: "Authentic action brings joy.", source: "Selected Poems" },
                    { text: "Sell your cleverness and buy bewilderment.", insight: "Wonder is worth more than intellect.", source: "Selected Poems" },
                    { text: "Ignore those that make you fearful and sad, that degrade you back towards disease and death.", insight: "Choose uplifting company.", source: "Selected Poems" },
                    { text: "There is a candle in your heart, ready to be kindled. There is a void in your soul, ready to be filled.", insight: "Potential awaits ignition.", source: "Selected Poems" },
                    { text: "Words are a pretext. It is the inner bond that draws one person to another, not words.", insight: "Connection goes beyond language.", source: "Selected Poems" },
                    { text: "Set your life on fire. Seek those who fan your flames.", insight: "Passion requires support.", source: "Selected Poems" },
                    { text: "Be empty of worrying. Think of who created thought.", insight: "Trust in the source.", source: "Selected Poems" },
                    { text: "Let the beauty of what you love be what you do.", insight: "Work should be love made visible.", source: "Selected Poems" }
                ]
            }
        };

        // --- DOM Elements ---
        const els = {
            selectionScreen: document.getElementById('selection-screen'),
            typingScreen: document.getElementById('typing-screen'),
            resultsScreen: document.getElementById('results-screen'),
            quoteSelection: document.getElementById('quote-selection'),
            quoteList: document.getElementById('quote-list'),
            wordsContainer: document.getElementById('words'),
            caret: document.getElementById('caret'),
            hiddenInput: document.getElementById('hidden-input'),
            root: document.documentElement,
            masterIndicator: document.getElementById('master-indicator'),
            liveWpm: document.getElementById('live-wpm'),
            liveAcc: document.getElementById('live-acc'),
            statsBar: document.getElementById('stats-bar'), 
            canvas: document.getElementById('battle-canvas'),
            wpmCanvas: document.getElementById('wpm-chart'),
            resWpm: document.getElementById('res-wpm'),
            resAcc: document.getElementById('res-acc'),
            resTime: document.getElementById('res-time'),
            resInsight: document.getElementById('res-insight'),
            scoreBreakdown: document.getElementById('score-breakdown')
        };

        // --- State ---
        let state = {
            master: null,
            text: "",
            words: [],
            insight: "",
            source: "", // Add source to state
            charIndex: 0,
            startTime: null,
            timer: null,
            history: [],
            isRunning: false,
            lastQuoteIndex: -1,
            wpmHistory: [],
            lastCheckIndex: 0,
            chartData: [], 
            intervalError: false,
            totalErrors: 0 
        };

        // --- Battle System (Canvas Engine) ---
        class BattleEngine {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.width = 0;
                this.height = 0;
                this.colors = { accent: '#d79921', red: '#cc241d', bg: '#1d2021' };
                
                this.hero = { x: 0, y: 0, state: 'IDLE', frame: 0, attackTimer: 0 };
                this.enemies = [];
                this.particles = [];
                this.floorOffset = 0;
                this.currentPct = 0; 
                
                this.loop = this.loop.bind(this);
                requestAnimationFrame(this.loop);
            }

            resize() {
                const rect = this.canvas.getBoundingClientRect();
                if (rect.width === 0) return; 
                this.canvas.width = rect.width;
                this.canvas.height = rect.height;
                this.width = rect.width;
                this.height = rect.height;
                this.updateColors();
            }

            updateColors() {
                const s = getComputedStyle(document.documentElement);
                this.colors.accent = s.getPropertyValue('--accent').trim();
                this.colors.red = s.getPropertyValue('--red').trim();
            }

            reset(enemiesConfig) {
                this.resize();
                this.hero.x = 20;
                this.hero.state = 'IDLE';
                this.hero.attackTimer = 0;
                this.floorOffset = 0;
                this.particles = [];
                this.currentPct = 0;
                
                this.enemies = enemiesConfig.map(cfg => ({
                    xPct: cfg.pct, 
                    type: cfg.type, 
                    alive: true,
                    animTimer: Math.random() * 10
                }));
            }

            updateProgress(pct) {
                this.currentPct = pct;
            }

            updatePhysics() {
                if (this.hero.attackTimer > 0) {
                    this.hero.attackTimer -= 1;
                    this.hero.state = 'ATTACK';
                }

                const targetX = 20 + (this.currentPct * (this.width - 100));
                const diff = targetX - this.hero.x;
                if (Math.abs(diff) > 1) {
                    this.hero.x += diff * 0.1; 
                    if (this.hero.attackTimer <= 0) {
                        this.hero.state = 'RUN';
                    }
                    this.floorOffset += diff * 0.1;
                } else {
                    this.hero.x = targetX; 
                    if (this.hero.attackTimer <= 0) {
                        this.hero.state = 'IDLE';
                    }
                }

                this.enemies.forEach(e => {
                    const eX = 20 + (e.xPct * (this.width - 100));
                    if (e.alive) {
                        if (e.type === 'BOSS') {
                            if (this.currentPct >= 1.0 && this.hero.x >= eX - 60) {
                                this.killEnemy(e, eX);
                            }
                        } else {
                            if (this.hero.x >= eX - 40) {
                                this.killEnemy(e, eX);
                            }
                        }
                    }
                });
            }

            killEnemy(e, x) {
                e.alive = false;
                this.hero.state = 'ATTACK';
                this.hero.attackTimer = 20; 

                const isBoss = e.type === 'BOSS';
                const pCount = isBoss ? 100 : 20; 
                const pSpeed = isBoss ? 15 : 8;

                for(let i=0; i<pCount; i++) {
                    this.particles.push({
                        x: x + 20, y: this.height - 40,
                        vx: (Math.random()-0.5)*pSpeed, 
                        vy: (Math.random()-1.2)*pSpeed,
                        life: 1.0 + Math.random(), 
                        color: (Math.random() > 0.8 ? '#fff' : this.colors.red), 
                        size: (Math.random() * (isBoss ? 6 : 3)) + 2 
                    });
                }
            }

            loop() {
                if (this.width === 0) { requestAnimationFrame(this.loop); return; }

                this.updatePhysics(); 

                this.ctx.fillStyle = "#151718"; 
                this.ctx.fillRect(0,0,this.width, this.height);

                this.ctx.fillStyle = this.colors.bg;
                const floorY = this.height - 20;
                const tileSize = 20;
                for(let i=0; i < (this.width/tileSize)+2; i++) {
                    const drawX = (i * tileSize) - (this.floorOffset % tileSize);
                    if (i%2===0) this.ctx.fillRect(drawX, floorY, tileSize, 20);
                }

                this.enemies.forEach(e => {
                    const x = 20 + (e.xPct * (this.width - 100));
                    const y = this.height - 50; 
                    if (e.alive) {
                        e.animTimer += 0.1;
                        const bob = Math.sin(e.animTimer)*3;
                        if (e.type === 'MINION') this.drawSprite(x, y + bob, this.colors.red, 'SKULL');
                        else this.drawSprite(x, y - 20 + bob, this.colors.red, 'DEMON');
                    }
                });

                const y = this.height - 50;
                this.hero.frame += 0.2;
                
                if (this.hero.state === 'ATTACK') {
                    this.drawSprite(this.hero.x, y, this.colors.accent, 'KNIGHT_ATTACK');
                    this.drawSlash(this.hero.x, y);
                } else {
                    const runBob = this.hero.state === 'RUN' ? Math.abs(Math.sin(this.hero.frame))*5 : 0;
                    this.drawSprite(this.hero.x, y - runBob, this.colors.accent, 'KNIGHT');
                }

                this.particles.forEach((p, i) => {
                    p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life -= 0.03;
                    this.ctx.fillStyle = p.color;
                    this.ctx.globalAlpha = Math.max(0, p.life);
                    this.ctx.fillRect(p.x, p.y, p.size, p.size);
                    this.ctx.globalAlpha = 1;
                    if (p.life <= 0) this.particles.splice(i, 1);
                });

                requestAnimationFrame(this.loop);
            }

            drawSlash(x, y) {
                this.ctx.fillStyle = '#fff';
                this.ctx.globalAlpha = 0.8;
                this.ctx.beginPath();
                this.ctx.moveTo(x + 40, y - 10);
                this.ctx.quadraticCurveTo(x + 90, y + 20, x + 40, y + 50);
                this.ctx.quadraticCurveTo(x + 70, y + 20, x + 40, y - 10);
                this.ctx.fill();
                this.ctx.globalAlpha = 1;
            }

            drawSprite(x, y, color, type) {
                const s = 4; 
                this.ctx.fillStyle = color;
                const dark = '#1d2021';
                
                if (type === 'KNIGHT') {
                    this.ctx.fillRect(x+1*s, y+2*s, 3*s, 3*s); 
                    this.ctx.fillRect(x+1*s, y, 3*s, 2*s);
                    this.ctx.fillStyle = '#cc241d';
                    this.ctx.fillRect(x+2*s, y-1*s, 2*s, 1*s);
                    this.ctx.fillStyle = '#ebdbb2';
                    this.ctx.fillRect(x+4*s, y-1*s, 1*s, 4*s);
                }
                else if (type === 'KNIGHT_ATTACK') {
                    this.ctx.fillRect(x+1*s, y+2*s, 3*s, 3*s); 
                    this.ctx.fillRect(x+1*s, y, 3*s, 2*s); 
                    this.ctx.fillStyle = '#ebdbb2';
                    this.ctx.fillRect(x+4*s, y+2*s, 4*s, 1*s); 
                }
                else if (type === 'SKULL') {
                    this.ctx.fillStyle = color;
                    this.ctx.fillRect(x, y, 4*s, 4*s); 
                    this.ctx.fillStyle = dark;
                    this.ctx.fillRect(x+1*s, y+1*s, 1*s, 1*s); 
                    this.ctx.fillRect(x+3*s, y+1*s, 1*s, 1*s); 
                }
                else if (type === 'DEMON') {
                    this.ctx.fillStyle = color;
                    this.ctx.fillRect(x, y, 8*s, 8*s); 
                    this.ctx.fillStyle = '#fabd2f'; 
                    this.ctx.fillRect(x, y-2*s, 1*s, 3*s);
                    this.ctx.fillRect(x+7*s, y-2*s, 1*s, 3*s);
                    this.ctx.fillStyle = '#fff'; 
                    this.ctx.fillRect(x+2*s, y+2*s, 1*s, 1*s);
                    this.ctx.fillRect(x+5*s, y+2*s, 1*s, 1*s);
                }
            }
        }

        const battle = new BattleEngine(els.canvas);

        // --- Logic: Init & Navigation ---
        
        const container = document.getElementById('masters-grid-container');
        Object.values(masters).forEach(m => {
            const card = document.createElement('div');
            card.className = 'master-card card-accent-hover';
            card.style.setProperty('--hover-color', m.color);
            card.onclick = () => selectMaster(m.key);
            
            card.innerHTML = `
                <div class="master-info">
                    <div class="master-role">${m.role}</div>
                    <div class="master-name">${m.name}</div>
                    <div class="master-quote-preview">"${m.quotes[0].text}"</div>
                </div>
            `;
            container.appendChild(card);
        });

        function selectMaster(key) {
            state.master = masters[key];
            els.root.style.setProperty('--accent', state.master.color);
            els.masterIndicator.innerText = state.master.role;
            state.lastQuoteIndex = -1; 
            
            els.selectionScreen.classList.add('hidden');
            els.typingScreen.classList.remove('hidden');
            els.typingScreen.classList.add('fade-in');
            
            battle.updateColors();
            battle.resize();
            
            initGame();
        }

        function toMenu() {
            els.resultsScreen.classList.add('hidden');
            els.typingScreen.classList.add('hidden');
            els.selectionScreen.classList.remove('hidden');
            state.isRunning = false;
        }

        function initGame(quoteIndex = null) {
            // Reset Logic
            state.charIndex = 0;
            state.startTime = null;
            state.isRunning = false;
            state.history = [];
            state.wpmHistory = [];
            state.chartData = []; 
            state.intervalError = false;
            state.lastCheckIndex = 0;
            state.totalErrors = 0; 
            els.hiddenInput.value = '';
            els.statsBar.style.opacity = '0.5';
            
            // Pick Quote (No Repeat Logic)
            const list = state.master.quotes;
            let qIdx;
            
            if (quoteIndex !== null) {
                qIdx = quoteIndex;
            } else {
                if (list.length > 1) {
                    do {
                        qIdx = Math.floor(Math.random() * list.length);
                    } while (qIdx === state.lastQuoteIndex);
                } else {
                    qIdx = 0;
                }
            }
            
            state.lastQuoteIndex = qIdx; 
            const q = list[qIdx];
            state.text = q.text;
            state.insight = q.insight;
            state.source = q.source; // Store source
            
            // Build DOM
            const words = state.text.split(' ');
            els.wordsContainer.innerHTML = '';
            state.words = [];
            
            words.forEach((w, wIdx) => {
                const wDiv = document.createElement('div');
                wDiv.className = 'word';
                [...w].forEach(c => {
                    const span = document.createElement('span');
                    span.className = 'letter';
                    span.innerText = c;
                    wDiv.appendChild(span);
                    // Add 'word' property for mapping
                    state.words.push({ char: c, el: span, word: w });
                });
                if (wIdx < words.length - 1) {
                    const sSpan = document.createElement('span');
                    sSpan.className = 'letter';
                    sSpan.innerHTML = '&nbsp;';
                    wDiv.appendChild(sSpan);
                    state.words.push({ char: ' ', el: sSpan, word: ' ' });
                }
                els.wordsContainer.appendChild(wDiv);
            });

            // Reset Battle (Boss at 100%)
            battle.reset([
                { pct: 0.25, type: 'MINION' },
                { pct: 0.50, type: 'MINION' },
                { pct: 0.75, type: 'MINION' },
                { pct: 1.0, type: 'BOSS' } 
            ]);

            els.hiddenInput.focus();
            updateCaret();
        }

        // New Helper Functions
        function retryMission() {
            els.resultsScreen.classList.add('hidden');
            initGame(state.lastQuoteIndex); 
        }

        function nextMission() {
            els.resultsScreen.classList.add('hidden');
            initGame(null); 
        }

        // --- Logic: Typing Engine ---

        document.addEventListener('keydown', e => {
            if (!els.quoteSelection.classList.contains('hidden')) {
                if(e.key === 'Escape') closeQuoteSelection();
                return;
            }
            if (!els.resultsScreen.classList.contains('hidden')) {
                if(e.key === 'Enter') nextMission(); 
                if(e.key === 'Tab') { e.preventDefault(); retryMission(); } 
                if(e.key === 'Escape') toMenu();
                return;
            }
            if (els.typingScreen.classList.contains('hidden')) return;

            if (e.key === 'Tab') { e.preventDefault(); retryMission(); } 
            if (e.key === 'Escape') toMenu();
            els.hiddenInput.focus();
        });

        els.hiddenInput.addEventListener('input', e => {
            if (!state.words || state.charIndex >= state.words.length) return;
            if (!els.quoteSelection.classList.contains('hidden')) return; 

            const char = els.hiddenInput.value.slice(-1);
            const type = e.inputType;
            
            if (!state.isRunning) {
                state.isRunning = true;
                state.startTime = Date.now();
                startStatsLoop();
                els.statsBar.style.opacity = '1';
            }

            if (type === 'deleteContentBackward') {
                if (state.charIndex > 0) {
                    state.charIndex--;
                    const item = state.words[state.charIndex];
                    item.el.className = 'letter';
                    state.history.pop();
                }
            } 
            else if (char) {
                const target = state.words[state.charIndex];
                if (char === target.char) {
                    target.el.classList.add('correct');
                    state.history.push(true);
                } else {
                    target.el.classList.add('incorrect');
                    state.history.push(false);
                    state.intervalError = true; 
                    state.totalErrors++; 
                }
                state.charIndex++;
            }

            els.hiddenInput.value = ' ';
            updateCaret();
            
            // Update Battle
            const progress = state.charIndex / state.words.length;
            battle.updateProgress(progress);

            if (state.charIndex === state.words.length) endGame();
        });

        function updateCaret() {
            if (state.charIndex < state.words.length) {
                const rect = state.words[state.charIndex].el.getBoundingClientRect();
                const wrap = document.getElementById('game-wrapper').getBoundingClientRect();
                els.caret.style.top = (rect.top - wrap.top) + 'px';
                els.caret.style.left = (rect.left - wrap.left) + 'px';
            }
        }

        function startStatsLoop() {
            if (state.timer) clearInterval(state.timer);
            state.timer = setInterval(() => {
                if (!state.isRunning) return;
                
                // Interval WPM Logic (Every 500ms)
                const chars = state.charIndex - state.lastCheckIndex;
                const intervalWpm = Math.max(0, Math.round((chars / 5) / (0.5 / 60))); 
                
                // Find Current Word for Data
                let idx = state.charIndex - 1;
                if (idx < 0) idx = 0;
                
                let currentItem = state.words[idx];
                
                if (currentItem && currentItem.word === ' ' && idx > 0) {
                    currentItem = state.words[idx - 1];
                }

                const currentWord = currentItem ? currentItem.word : "";

                state.chartData.push({
                    wpm: intervalWpm,
                    word: currentWord,
                    error: state.intervalError
                });
                
                // Reset interval trackers
                state.intervalError = false; 
                state.lastCheckIndex = state.charIndex;

                // Live WPM Display
                const mins = (Date.now() - state.startTime) / 60000;
                const wpm = Math.round((state.charIndex/5) / mins) || 0;
                els.liveWpm.innerText = wpm;
            }, 500);
        }

        // --- Chart & Interaction ---
        
        let chartHoverX = null;

        function drawWpmChart(hoverX = null) {
            const cvs = els.wpmCanvas;
            const ctx = cvs.getContext('2d');
            
            // Fix resolution
            const rect = cvs.getBoundingClientRect();
            cvs.width = rect.width;
            cvs.height = rect.height;
            
            const w = cvs.width;
            const h = cvs.height;
            const data = state.chartData;
            const accent = state.master.color;
            const red = '#cc241d';

            // Background
            ctx.fillStyle = '#1d2021';
            ctx.fillRect(0, 0, w, h);
            ctx.strokeStyle = '#3c3836';
            ctx.lineWidth = 1;
            
            // Grid Lines
            for(let i=0; i<5; i++) {
                let y = (h/4)*i;
                ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
            }

            if (data.length < 2) return;

            // Calculate Scale
            const maxWpm = Math.max(100, ...data.map(d => d.wpm)) + 10;
            const xStep = w / (data.length - 1);

            // Draw Line
            ctx.strokeStyle = accent;
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            data.forEach((d, i) => {
                const x = i * xStep;
                const y = h - ((d.wpm / maxWpm) * h);
                if (i===0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();

            // Draw Fill
            ctx.lineTo(w, h);
            ctx.lineTo(0, h);
            ctx.fillStyle = accent + '33'; 
            ctx.fill();

            // Draw Error Markers (X)
            ctx.strokeStyle = red;
            ctx.lineWidth = 2;
            data.forEach((d, i) => {
                if (d.error) {
                    const x = i * xStep;
                    const y = h - ((d.wpm / maxWpm) * h);
                    // Draw X
                    ctx.beginPath();
                    ctx.moveTo(x-4, y-4); ctx.lineTo(x+4, y+4);
                    ctx.moveTo(x+4, y-4); ctx.lineTo(x-4, y+4);
                    ctx.stroke();
                }
            });

            // Draw Hover Tooltip
            if (hoverX !== null) {
                // Find closest index
                const idx = Math.min(Math.max(0, Math.round(hoverX / xStep)), data.length - 1);
                const d = data[idx];
                const x = idx * xStep;
                const y = h - ((d.wpm / maxWpm) * h);

                // Cursor Line
                ctx.strokeStyle = '#ebdbb2';
                ctx.lineWidth = 1;
                ctx.setLineDash([4, 4]);
                ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke();
                ctx.setLineDash([]);

                // Point
                ctx.fillStyle = '#ebdbb2';
                ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI*2); ctx.fill();

                // Dynamic Tooltip Box
                const isSpace = !d.word || d.word === ' ';
                const tipW = 100;
                const tipH = isSpace ? 30 : 50; // Smaller box if no word shown
                let tipX = x + 10;
                let tipY = y - 60;
                
                // Boundaries
                if (tipX + tipW > w) tipX = x - 110;
                if (tipY < 0) tipY = y + 20;

                ctx.fillStyle = '#282828';
                ctx.strokeStyle = accent;
                ctx.lineWidth = 2;
                ctx.fillRect(tipX, tipY, tipW, tipH);
                ctx.strokeRect(tipX, tipY, tipW, tipH);

                // Text
                ctx.fillStyle = '#ebdbb2';
                ctx.font = '16px VT323';
                ctx.textAlign = 'left';
                ctx.fillText(`WPM: ${d.wpm}`, tipX + 10, tipY + 20);
                
                if (!isSpace) {
                    // Truncate word if too long
                    let wordDisp = d.word.length > 10 ? d.word.substr(0,9) + '..' : d.word;
                    ctx.fillText(`Word: ${wordDisp}`, tipX + 10, tipY + 40);
                }
            }
        }

        // Add Interaction Listeners
        els.wpmCanvas.addEventListener('mousemove', (e) => {
            const rect = els.wpmCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            drawWpmChart(x);
        });

        els.wpmCanvas.addEventListener('mouseleave', () => {
            drawWpmChart(null);
        });


        function endGame() {
            state.isRunning = false;
            clearInterval(state.timer);
            const time = (Date.now() - state.startTime) / 1000;
            const wpm = Math.round((state.words.length/5) / (time/60));
            const acc = Math.round((state.history.filter(Boolean).length / state.words.length) * 100);

            // --- Score Calculation ---
            const baseScore = Math.round((wpm * 50) + (state.words.length * 10));
            const penalty = state.totalErrors * 150;
            const finalScore = Math.max(0, baseScore - penalty);

            battle.updateProgress(1.0);

            setTimeout(() => {
                els.resWpm.innerText = wpm;
                els.resAcc.innerText = acc + '%';
                els.resTime.innerText = time.toFixed(1) + 's';
                
                // Inject Insight and Source
                els.resInsight.innerHTML = `
                    ${state.insight}
                    <span class="insight-source"> From: ${state.source}</span>
                `;
                
                // Render Score Box
                els.scoreBreakdown.innerHTML = `
                    <div class="score-row">
                        <span>Base Score (Speed & Length)</span>
                        <span>${baseScore}</span>
                    </div>
                    <div class="score-row score-penalty">
                        <span>Penalty (${state.totalErrors} Errors)</span>
                        <span>-${penalty}</span>
                    </div>
                    <div class="score-row final">
                        <span>FINAL SCORE</span>
                        <span>${finalScore}</span>
                    </div>
                `;

                els.resultsScreen.classList.remove('hidden');
                drawWpmChart(); // Initial Draw
            }, 1000);
        }

        function restartGame() {
            els.resultsScreen.classList.add('hidden');
            initGame();
        }

        // --- Menu Logic ---
        function showQuoteSelection() {
            const list = els.quoteList;
            list.innerHTML = '';
            state.master.quotes.forEach((q, i) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerText = `"${q.text}"`;
                item.onclick = () => {
                    closeQuoteSelection();
                    initGame(i);
                };
                list.appendChild(item);
            });
            els.quoteSelection.classList.remove('hidden');
        }

        function closeQuoteSelection() {
            els.quoteSelection.classList.add('hidden');
            els.hiddenInput.focus();
        }

        window.addEventListener('resize', () => {
            if (!els.typingScreen.classList.contains('hidden')) {
                battle.resize();
                updateCaret();
                // Redraw chart if visible (results screen)
                if(!els.resultsScreen.classList.contains('hidden')) drawWpmChart();
            }
        });

    </script>
</body>
</html>
